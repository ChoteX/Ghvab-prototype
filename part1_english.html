<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading…</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Latin+Modern+Roman:ital,wght@0,400;0,700;1,400;1,700&family=Noto+Serif+Georgian:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="katex/katex.min.css">
    <link rel="stylesheet" href="styles.css">
    <script defer src="katex/katex.min.js"></script>
    <script defer src="katex/contrib/auto-render.min.js"></script>
</head>
<body class="with-header">
    <header class="page-header">
        <div class="header-inner">
            <h1 class="header-title"></h1>
            <div class="header-links">
                <a class="header-link" href="exercises/index.html">Exercises</a>
                <button type="button" class="language-toggle" id="language-toggle" aria-pressed="false">
                    ქართული ვერსია
                </button>
            </div>
        </div>
    </header>

    <div class="page-layout">
        <aside class="sidebar">
            <h2></h2>
            <nav aria-label="">
                <ul class="toc-list" id="toc"></ul>
            </nav>
        </aside>
        <main class="main-content" id="main-content">
            <p id="content-status" class="loading-message">Loading…</p>
        </main>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const katexConfig = {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "\\[", right: "\\]", display: true },
                    { left: "$", right: "$", display: false },
                    { left: "\\(", right: "\\)", display: false },
                    { left: "\\begin{align}", right: "\\end{align}", display: true },
                    { left: "\\begin{align*}", right: "\\end{align*}", display: true }
                ],
                macros: {
                    "\\dotsep": ",\\ldots,",
                    "\\Z": "\\mathbb{Z}"
                }
            };

            const resources = {
                en: "content-en.json",
                ka: "content-ka.json"
            };
            const languageSequence = Object.keys(resources);
            const cache = new Map();

            const mainContent = document.getElementById("main-content");
            const tocList = document.getElementById("toc");
            const toggleButton = document.getElementById("language-toggle");
            const headerTitle = document.querySelector(".header-title");
            const sidebarTitle = document.querySelector(".sidebar h2");
            const sidebarNav = document.querySelector(".sidebar nav");
            const statusMessage = document.getElementById("content-status");

            let activeLanguage = "en";
            let currentMeta = null;

            function clearElement(element) {
                if (!element) {
                    return;
                }
                while (element.firstChild) {
                    element.removeChild(element.firstChild);
                }
            }

            function renderNodes(nodes, parent) {
                if (!parent || !Array.isArray(nodes)) {
                    return;
                }

                nodes.forEach((node) => {
                    if (!node) {
                        return;
                    }

                    if (node.type === "text") {
                        parent.appendChild(document.createTextNode(node.text || ""));
                        return;
                    }

                    if (node.type === "element") {
                        const element = document.createElement(node.tag);

                        if (Array.isArray(node.classes) && node.classes.length > 0) {
                            element.className = node.classes.join(" ");
                        }

                        if (node.attributes) {
                            Object.entries(node.attributes).forEach(([name, value]) => {
                                if (value === undefined || value === null) {
                                    return;
                                }
                                element.setAttribute(name, value);
                            });
                        }

                        if (Array.isArray(node.children) && node.children.length > 0) {
                            renderNodes(node.children, element);
                        }

                        parent.appendChild(element);
                    }
                });
            }

            function applyMeta(meta) {
                currentMeta = meta || {};

                if (meta?.pageTitle) {
                    document.title = meta.pageTitle;
                }

                if (meta?.documentLang) {
                    document.documentElement.setAttribute("lang", meta.documentLang);
                }

                if (headerTitle) {
                    headerTitle.textContent = meta?.headerTitle || "";
                }

                if (sidebarTitle) {
                    sidebarTitle.textContent = meta?.sidebarTitle || "";
                }

                if (sidebarNav && meta?.sidebarAriaLabel) {
                    sidebarNav.setAttribute("aria-label", meta.sidebarAriaLabel);
                }
            }

            function createSlug(text, slugCounts) {
                const base = text
                    .toLowerCase()
                    .normalize("NFKD")
                    .replace(/[^\p{Letter}\p{Number}]+/gu, "-")
                    .replace(/^-+|-+$/g, "") || "section";

                slugCounts[base] = (slugCounts[base] || 0) + 1;
                const count = slugCounts[base];
                return count === 1 ? base : `${base}-${count}`;
            }

            function setActiveTocLink(id, registry) {
                registry.forEach((link) => link.classList.remove("active", "active-parent"));

                const activeLink = registry.get(id);
                if (!activeLink) {
                    return;
                }

                activeLink.classList.add("active");

                const parentSublist = activeLink.closest(".toc-sublist");
                if (parentSublist) {
                    const parentLink = parentSublist.previousElementSibling;
                    if (parentLink) {
                        parentLink.classList.add("active-parent");
                    }
                }
            }

            function initializeTableOfContents() {
                if (!tocList || !mainContent) {
                    return;
                }

                tocList.innerHTML = "";

                const headings = Array.from(mainContent.querySelectorAll("h1, h2, h3"));
                const slugCounts = Object.create(null);
                const linkRegistry = new Map();
                let currentSectionItem = null;

                headings.forEach((heading) => {
                    const level = Number(heading.tagName.substring(1));
                    if (Number.isNaN(level) || level > 3) {
                        return;
                    }

                    const text = heading.textContent.replace(/\s+/g, " ").trim();
                    if (!text) {
                        return;
                    }

                    if (!heading.id) {
                        heading.id = createSlug(text, slugCounts);
                    }

                    const link = document.createElement("a");
                    link.className = "toc-link";
                    link.href = `#${heading.id}`;
                    link.textContent = text;
                    link.addEventListener("click", (event) => {
                        event.preventDefault();
                        document.getElementById(heading.id)?.scrollIntoView({ behavior: "smooth", block: "start" });
                        setActiveTocLink(heading.id, linkRegistry);
                    });

                    const listItem = document.createElement("li");
                    listItem.appendChild(link);

                    if (level === 3 && currentSectionItem) {
                        let sublist = currentSectionItem.querySelector(".toc-sublist");
                        if (!sublist) {
                            sublist = document.createElement("ul");
                            sublist.className = "toc-sublist";
                            currentSectionItem.appendChild(sublist);
                        }
                        sublist.appendChild(listItem);
                    } else {
                        tocList.appendChild(listItem);
                        currentSectionItem = listItem;
                    }

                    linkRegistry.set(heading.id, link);
                });

                if (linkRegistry.size === 0) {
                    return;
                }

                const observer = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            setActiveTocLink(entry.target.id, linkRegistry);
                        }
                    });
                }, {
                    rootMargin: "-60% 0px -35% 0px",
                    threshold: [0, 1]
                });

                headings.forEach((heading) => observer.observe(heading));
            }

            function resetQuiz(form, resultContainer) {
                Array.from(form.querySelectorAll("input[type=\"radio\"]")).forEach((input) => {
                    input.checked = false;
                });

                Array.from(form.querySelectorAll(".quiz-choice")).forEach((choice) => {
                    choice.classList.remove("correct", "incorrect");
                });

                Array.from(form.querySelectorAll(".quiz-feedback")).forEach((feedback) => {
                    feedback.textContent = "";
                    feedback.classList.add("hidden");
                });

                resultContainer.textContent = "";
            }

            function evaluateQuiz(form, answerKey, resultContainer, language) {
                const questions = Array.from(form.querySelectorAll(".quiz-question"));
                let score = 0;
                let total = 0;
                let unscored = 0;

                questions.forEach((questionEl) => {
                    const questionId = questionEl.dataset.questionId;
                    const key = answerKey[questionId];
                    if (!key) {
                        return;
                    }

                    const feedback = questionEl.querySelector(".quiz-feedback");
                    const choices = Array.from(questionEl.querySelectorAll(".quiz-choice"));
                    choices.forEach((choice) => choice.classList.remove("correct", "incorrect"));

                    const selected = questionEl.querySelector("input:checked");

                    if (key.scored) {
                        total += 1;
                    } else {
                        unscored += 1;
                    }

                    if (key.correct) {
                        choices.forEach((choice) => {
                            const input = choice.querySelector("input");
                            if (input?.value === key.correct) {
                                choice.classList.add("correct");
                            }
                        });
                    }

                    if (selected && key.correct && selected.value !== key.correct) {
                        selected.closest(".quiz-choice")?.classList.add("incorrect");
                    }

                    if (selected && key.correct && selected.value === key.correct && key.scored) {
                        score += 1;
                    }

                    if (feedback) {
                        feedback.textContent = key.explanation || "";
                        feedback.classList.remove("hidden");
                    }
                });

                if (!resultContainer) {
                    return;
                }

                const summary = [];
                if (total > 0) {
                    if (language === "ka") {
                        summary.push(`სწორად უპასუხეთ ${score} კითხვას ${total}-დან, რომელიც შეფასდა.`);
                    } else {
                        const suffix = total === 1 ? "" : "s";
                        summary.push(`You answered ${score} out of ${total} scored question${suffix} correctly.`);
                    }
                }
                if (unscored > 0) {
                    if (language === "ka") {
                        summary.push(`${unscored} დამატებითი კითხვა მოითხოვს ხელით გადამოწმებას, რადგან ტექსტი ფრაგმენტულად არის გადმოცემული.`);
                    } else {
                        const suffix = unscored === 1 ? "question" : "questions";
                        summary.push(`${unscored} additional ${suffix} require manual review because of incomplete source text.`);
                    }
                }

                resultContainer.textContent = summary.join(" ");
            }

            function initializeQuiz(answerKey, language) {
                const quizForm = document.getElementById("control-test");
                const finishButton = document.getElementById("finish-quiz");
                const resetButton = document.getElementById("reset-quiz");
                const resultContainer = document.getElementById("quiz-result");

                if (!quizForm || !finishButton || !resetButton || !resultContainer) {
                    return;
                }

                finishButton.addEventListener("click", () => {
                    evaluateQuiz(quizForm, answerKey, resultContainer, language);
                    renderMathInElement(quizForm, katexConfig);
                });

                resetButton.addEventListener("click", () => {
                    resetQuiz(quizForm, resultContainer);
                    renderMathInElement(quizForm, katexConfig);
                });
            }

            function getNextLanguage(current) {
                const index = languageSequence.indexOf(current);
                if (index === -1) {
                    return languageSequence[0];
                }
                return languageSequence[(index + 1) % languageSequence.length];
            }

            function updateToggle(meta) {
                if (!toggleButton) {
                    return;
                }

                toggleButton.textContent = meta?.toggleLabelInactive || toggleButton.textContent || "";
                toggleButton.dataset.nextLang = getNextLanguage(activeLanguage);
                toggleButton.setAttribute("aria-pressed", activeLanguage === languageSequence[0] ? "false" : "true");
            }

            async function loadLanguage(lang) {
                if (!resources[lang]) {
                    return;
                }

                activeLanguage = lang;

                if (toggleButton) {
                    toggleButton.disabled = true;
                }

                if (statusMessage) {
                    statusMessage.textContent = lang === "ka" ? "იტვირთება…" : "Loading…";
                    statusMessage.classList.remove("hidden");
                }

                try {
                    let data = cache.get(lang);
                    if (!data) {
                        const response = await fetch(resources[lang]);
                        if (!response.ok) {
                            throw new Error(`Failed to load ${resources[lang]} (${response.status})`);
                        }
                        data = await response.json();
                        cache.set(lang, data);
                    }

                    applyMeta(data.meta);
                    updateToggle(data.meta);

                    if (mainContent) {
                        clearElement(mainContent);
                        renderNodes(data.mainContent, mainContent);
                        renderMathInElement(mainContent, katexConfig);
                    }

                    initializeTableOfContents();
                    initializeQuiz(data.answerKey || {}, data.meta?.documentLang || "en");

                    if (statusMessage) {
                        statusMessage.textContent = "";
                        statusMessage.classList.add("hidden");
                    }
                } catch (error) {
                    if (mainContent) {
                        clearElement(mainContent);
                        const errorMessage = document.createElement("p");
                        errorMessage.className = "error-message";
                        errorMessage.textContent = lang === "ka"
                            ? "შეცდომა მოხდა შინაარსის ჩატვირთვისას. სცადეთ მოგვიანებით."
                            : "An error occurred while loading the content. Please try again later.";
                        mainContent.appendChild(errorMessage);
                    }
                    if (statusMessage) {
                        statusMessage.textContent = "";
                        statusMessage.classList.add("hidden");
                    }
                    // eslint-disable-next-line no-console
                    console.error(error);
                } finally {
                    if (toggleButton) {
                        toggleButton.disabled = false;
                    }
                }
            }

            if (toggleButton) {
                toggleButton.addEventListener("click", () => {
                    const targetLang = toggleButton.dataset.nextLang || getNextLanguage(activeLanguage);
                    loadLanguage(targetLang);
                });
            }

            loadLanguage(activeLanguage);
        });
    </script>
</body>
</html>
